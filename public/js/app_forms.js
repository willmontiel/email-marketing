App.defaultmailoptin = JSON.parse('{\"layout\":{\"id\":1,\"name\":\"layout-simple\",\"description\":\"Layout Standard\",\"icon\":\"/emarketing/images/n1.png\",\"zones\":[{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600}]},\"dz\":{\"preheader\":{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#ffffff\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]},\"header\":{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#ffffff\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<p></p><h3><strong>Por favor confirme su suscripción</strong></h3>\",\"type\":\"Text\"}],\"amount\":1}]},\"body\":{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#ffffff\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<p></p><p>Gracias por suscribirse a nuestro boletín.<br><br>Para completar su suscripción, haga clic en el enlace de confirmación abajo. Una vez hecho esto, su suscripción estará completa.<br><br><a href=\\\"%%CONFIRMLINK%%\\\">Por favor haga clic aquí­ para confirmar suscripción</a><br><br>o copie y pegue la siguiente URL en su navegador:<br>%%CONFIRMLINK%%</p>\",\"type\":\"Text\"}],\"amount\":1}]},\"footer\":{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#ffffff\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]}},\"content\":{},\"editorColor\":\"#E6E6E6\"}');
App.defaultmailwelcome = JSON.parse('{\"layout\":{\"id\":1,\"name\":\"layout-simple\",\"description\":\"Layout Standard\",\"icon\":\"/emarketing/images/n1.png\",\"zones\":[{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600}]},\"dz\":{\"preheader\":{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]},\"header\":{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<h3 style=\\\"text-align: center;\\\"><b>Bienvenido</b></h3>\",\"type\":\"Text\"}],\"amount\":1}]},\"body\":{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<p></p><p><b>Su suscripción ha sido completada.</b><br><br>Gracias por suscribirse a nuestra lista. Su suscripción ha sido completada. Si tiene preguntas puede contactarnos respondiendo a este email.</p>\",\"type\":\"Text\"}],\"amount\":1}]},\"footer\":{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]}},\"content\":{},\"editorColor\":\"#E6E6E6\"}');
App.defaultmailnotify = JSON.parse('{\"layout\":{\"id\":1,\"name\":\"layout-simple\",\"description\":\"Layout Standard\",\"icon\":\"/emarketing/images/n1.png\",\"zones\":[{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600}]},\"dz\":{\"preheader\":{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]},\"header\":{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<h3 style=\\\"text-align: center;\\\">Notificación</h3>\",\"type\":\"Text\"}],\"amount\":1}]},\"body\":{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<p><b>Nueva suscripción</b></p><p>Un nuevo contacto se ha suscrito a su lista.</p>\",\"type\":\"Text\"}],\"amount\":1}]},\"footer\":{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]}},\"content\":{},\"editorColor\":\"#E6E6E6\"}');
App.defaultmailcontactnotify = JSON.parse('{\"layout\":{\"id\":1,\"name\":\"layout-simple\",\"description\":\"Layout Standard\",\"icon\":\"/emarketing/images/n1.png\",\"zones\":[{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600},{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600}]},\"dz\":{\"preheader\":{\"name\":\"preheader\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]},\"header\":{\"name\":\"header\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<h3 style=\\\"text-align: center;\\\"><b>Actualización de datos</b></h3>\",\"type\":\"Text\"}],\"amount\":1}]},\"body\":{\"name\":\"body\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":[{\"background_color\":\"transparent\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"margin_top\":0,\"margin_bottom\":0,\"margin_left\":0,\"margin_right\":0,\"content\":\"<p></p><p><b>Su actualización ha sido completada.</b><br><br>Gracias por actualizar sus datos. Su actualización ha sido exitosa. Si tiene preguntas puede contactarnos respondiendo a este email.</p>\",\"type\":\"Text\"}],\"amount\":1}]},\"footer\":{\"name\":\"footer\",\"width\":\"full-width\",\"widthval\":600,\"parent\":\"#edit-area\",\"background_color\":\"#FFFFFF\",\"border_width\":0,\"border_color\":\"#FFFFFF\",\"border_style\":\"none\",\"corner_top_left\":0,\"corner_top_right\":0,\"corner_bottom_left\":0,\"corner_bottom_right\":0,\"content\":[]}},\"content\":{},\"editorColor\":\"#E6E6E6\"}');

App.Form = DS.Model.extend({
	name: DS.attr('string', { required: true }),
	type: DS.attr( 'string' ), 
	title: DS.attr( 'string' ), 
	urlsuccess: DS.attr( 'string' ),
	urlerror: DS.attr( 'string' ),
	optin: DS.attr( 'boolean' ),
	optinmail: DS.attr( 'string' ),
	welcome: DS.attr( 'boolean' ),
	welcomemail: DS.attr( 'string' ),
	welcomeurl: DS.attr( 'string' ),
	notify: DS.attr( 'boolean' ),
	notifyemail: DS.attr( 'string' ),
	notifymail: DS.attr( 'string' ),
	updatenotify: DS.attr( 'boolean' ),
	updatenotifymail: DS.attr( 'string' ),
	listselected: DS.attr( 'string' ),
	dbaseselected: DS.attr( 'string' ),
	content: DS.attr( 'string' ),
	framecode: DS.attr( 'string' ),
	html: DS.attr( 'string' ),
	isInscription: function() {
		var value = (this.get('type') === 'Inscription') ? true : false;
		return value;
	}.property('type')
});

App.FormsIndexRoute = Ember.Route.extend({
	model: function(){
		return this.store.find('form');
	}
});

App.FormsIndexController = Ember.ObjectController.extend({});

App.FormsNewRoute = Ember.Route.extend({
	deactivate: function () {
		this.doRollBack();
	},
	contextDidChange: function() {
		this.doRollBack();
		this._super();
    },
	doRollBack: function () {
		var model = this.get('currentModel');
		if (model && model.get('isDirty') && model.get('isSaving') == false) {
			model.rollback();
		}
	}
});

App.FormsNewController = Ember.ObjectController.extend(Ember.SaveHandlerMixin, {
	actions: {
		sendData: function() {
			var obj = JSON.stringify(formeditor.persist());
			this.content.set('content', obj);
			this.content.set('title', $('#form-title-name').text());
			this.handleSavePromise(this.content.save(), 'forms.index', 'El Formulario se ha modificado exitosamente');
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsNewView = Ember.View.extend({
	didInsertElement: function() {
		formeditor = new FormEditor();
		formeditor.startEvents(this.controller.content.get('content'));
    }
});

App.FormsSetupRoute = Ember.Route.extend({
	model: function(){
		return this.store.createRecord('form');
	},
	deactivate: function () {
		this.doRollBack();
	},
	contextDidChange: function() {
		this.doRollBack();
		this._super();
    },
	doRollBack: function () {
		var model = this.get('currentModel');
		if (model && model.get('isDirty') && model.get('isSaving') == false) {
			model.rollback();
		}
	}
});

App.FormsSetupController = Ember.ObjectController.extend( Ember.SaveFormHandlerMixin, {
	selectoflists: [],
	setSelectOfLists: function() {
		var t = this;
		this.store.find('list').then(function(list) {
			var lists = list.get('content');
			var values = [];
			for(var i = 0; i < lists.length; i++) {
				var obj = {id: lists[i].get('id'), name: lists[i].get('name')};
				values.push(obj);
			}
			t.set('selectoflists', values);
		});
	}.observes('content'),
	cleanEditor: function() {
		$('.title-advanced-editor').empty();
		$('.here-comes-frame').empty();
		$('.create-email-spot').hide();
		$('.btn-form-email-creator-save').hide();
		$('.form-setup-content').show();
	},
	checkValues: function(form) {
		if( form.get('name') === undefined ||  form.get('name').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar un NOMBRE al formulario'};
		}
		
		if( ( form.get('urlsuccess') === undefined || form.get('urlsuccess').length === 0 ) || ( form.get('urlerror') === undefined ) || form.get('urlerror').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar las URLs de EXITO y ERROR'};
		}

		if( form.get('optin') ) {
			if( form.get('optinsubject') === undefined && form.get('optinfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para OPTIN'};
			}
			var optin_mail = ( form.get('mailforoptin') === undefined ) ?  JSON.stringify(App.defaultmailoptin) : form.get('mailforoptin');
			
			form.set('optinmail', JSON.stringify({	
									subject: form.get('optinsubject'), 
									fromemail: form.get('optinfromemail'),
									fromname: form.get('optinfromname'),
									reply: form.get('optinreplyto'),
									mail: optin_mail }) );
		}
		
		if( form.get('welcome') ) {
			if( form.get('welcomesubject') === undefined && form.get('welcomefromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para BIENVENIDA'};
			}
			var welcome_mail = ( form.get('mailforwelcome') === undefined ) ?  JSON.stringify(App.defaultmailwelcome) : form.get('mailforwelcome');
			
			form.set('welcomemail', JSON.stringify({
									subject: form.get('welcomesubject'), 
									fromemail: form.get('welcomefromemail'),
									fromname: form.get('welcomefromname'),
									reply: form.get('welcomereplyto'),
									mail: welcome_mail }) );
		}
		
		if( form.get('notify') ) {
			if( form.get('notifysubject') === undefined && form.get('notifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para NOTIFICACIÓN'};
			}
			var notify_mail = ( form.get('mailfornotify') === undefined ) ?  JSON.stringify(App.defaultmailnotify) : form.get('mailfornotify');
			
			form.set('notifymail', JSON.stringify({
									subject: form.get('notifysubject'), 
									fromemail: form.get('notifyfromemail'),
									fromname: form.get('notifyfromname'),
									reply: form.get('notifyreplyto'),
									mail: notify_mail }) );
		}
		
		if( form.get('listselected') === undefined  || form.get('listselected') === 'none' || form.get('listselected') === null ) {
			return {acceptance: false, msg: 'Recuerde seleccionar una "LISTA"'};
		}
		
		return {acceptance: true, msg: ''};
	},
	actions: {
		show_editor: function(option) {
			$('.form-setup-content').hide();
			$('.create-email-spot').show();
			var msg = '';
			switch (option) {
				case 'optin':
					msg = 'Doble Optin';
					var mail = this.get('mailforoptin');
					var maildefault = App.defaultmailoptin;
					break;
				case 'welcome':
					msg = 'Bienvenida';
					var mail = this.get('mailforwelcome');
					var maildefault = App.defaultmailwelcome;
					break;
				case 'notify':
					msg = 'Notificación';
					var mail = this.get('mailfornotify');
					var maildefault = App.defaultmailnotify;
					break;
			}
			
			if( mail !== undefined ) {
				mail = ( typeof(mail) === 'object' ) ? mail : JSON.parse(mail);
			}
			objMail = ( mail === undefined ) ? maildefault : mail;
			
			$('.title-advanced-editor').html('<h5>Correo de ' + msg + ' </h5>');
			$('.here-comes-frame').html('<iframe id="iframeEditor" src="' + config.baseUrl + 'mail/editor_frame" width="100%" onload="iframeResize()" seamless></iframe>');
			$('#btn-for-' + option).show();
		},
		create_optin_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforoptin', editor);
			this.cleanEditor();
		},
		create_welcome_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforwelcome', editor);
			this.cleanEditor();
		},
		create_notify_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailfornotify', editor);
			this.cleanEditor();
		},
		next: function(form) {
			var result = this.checkValues(form);
			if(result.acceptance) {
				this.content.set('type', 'Inscription');
				this.handleSavePromise(this.content.save(), 'forms.new', 'Ok, listo');
			}
			else {
				$.gritter.add({title: 'Cuidado', text: result.msg, sticky: false, time: 5000});
			}
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsEditRoute = Ember.Route.extend({
	deactivate: function () {
		this.doRollBack();
	},
	contextDidChange: function() {
		this.doRollBack();
		this._super();
    },
	doRollBack: function () {
		var model = this.get('currentModel');
		if (model && model.get('isDirty') && model.get('isSaving') == false) {
			model.rollback();
		}
	}
});

App.FormsEditController = Ember.ObjectController.extend( Ember.SaveFormHandlerMixin, {
	selectoflists: [],
	setSelectOfLists: function() {
		if(this.content.get('listselected') === undefined) {
			this.content.set('listselected', this.get('listselectedvalue'));
		}
	}.observes('content.listselected'),
	loadData: function() {
		var t = this;
		this.set('listselectedvalue', this.content.get('listselected'));
		
		var idDbase = this.get('dbaseselected');
		this.store.find('list', { dbase: idDbase }).then(function(list) {
			var lists = list.get('content');
			var values = [];
			for(var i = 0; i < lists.length; i++) {
				var obj = {id: lists[i].get('id'), name: lists[i].get('name')};
				values.push(obj);
				if(lists[i].get('id') == t.content.get('listselected')) {
					t.set('listselectedfield', obj);
				}
			}
			t.set('selectoflists', values);
		});
		
		var form = this.content;
		
		var optininfo = JSON.parse(form.get('optinmail'));
		if( optininfo ) {
			form.set('mailforoptin', optininfo.mail);
			form.set('optinsubject', optininfo.subject);
			form.set('optinfromemail', optininfo.fromemail);
			form.set('optinfromname', optininfo.fromname);
			form.set('optinreplyto', optininfo.reply);	
		}
		
		var welcomeinfo = JSON.parse(form.get('welcomemail'));
		if( welcomeinfo ) {
			form.set('mailforwelcome', welcomeinfo.mail);
			form.set('welcomesubject', welcomeinfo.subject);
			form.set('welcomefromemail', welcomeinfo.fromemail);
			form.set('welcomefromname', welcomeinfo.fromname);
			form.set('welcomereplyto', welcomeinfo.reply);
		}
		
		var notifyinfo = JSON.parse(form.get('notifymail'));
		if( notifyinfo ) {
			form.set('mailfornotify', notifyinfo.mail);
			form.set('notifysubject', notifyinfo.subject);
			form.set('notifyfromemail', notifyinfo.fromemail);
			form.set('notifyfromname', notifyinfo.fromname);
			form.set('notifyreplyto', notifyinfo.reply);
		}
	}.observes('content'),
	cleanEditor: function() {
		$('.title-advanced-editor').empty();
		$('.here-comes-frame').empty();
		$('.create-email-spot').hide();
		$('.btn-form-email-creator-save').hide();
		$('.form-setup-content').show();
	},
	checkValues: function(form) {
		if( form.get('name') === undefined ||  form.get('name').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar un NOMBRE al formulario'};
		}
		
		if( ( form.get('urlsuccess') === undefined || form.get('urlsuccess').length === 0 ) || ( form.get('urlerror') === undefined ) || form.get('urlerror').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar las URLs de EXITO y ERROR'};
		}
		
		if( form.get('optin') ) {
			if( form.get('optinsubject') === undefined && form.get('optinfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para OPTIN'};
			}
			var optin_mail = ( form.get('mailforoptin') === undefined ) ? JSON.stringify(App.defaultmailoptin) : form.get('mailforoptin');
			
			form.set('optinmail', JSON.stringify({	
									subject: form.get('optinsubject'), 
									fromemail: form.get('optinfromemail'),
									fromname: form.get('optinfromname'),
									reply: form.get('optinreplyto'),
									mail: optin_mail }) );
		}
		
		if( form.get('welcome') ) {
			if( form.get('welcomesubject') === undefined && form.get('welcomefromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para BIENVENIDA'};
			}
			var welcome_mail = ( form.get('mailforwelcome') === undefined ) ? JSON.stringify(App.defaultmailwelcome) : form.get('mailforwelcome');
			
			form.set('welcomemail', JSON.stringify({
									subject: form.get('welcomesubject'), 
									fromemail: form.get('welcomefromemail'),
									fromname: form.get('welcomefromname'),
									reply: form.get('welcomereplyto'),
									mail: welcome_mail }) );
		}
		
		if( form.get('notify') ) {
			if( form.get('notifysubject') === undefined && form.get('notifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para NOTIFICACIÓN'};
			}
			var notify_mail = ( form.get('mailfornotify') === undefined ) ? JSON.stringify(App.defaultmailnotify) : form.get('mailfornotify');
			
			form.set('notifymail', JSON.stringify({
									subject: form.get('notifysubject'), 
									fromemail: form.get('notifyfromemail'),
									fromname: form.get('notifyfromname'),
									reply: form.get('notifyreplyto'),
									mail: notify_mail }) );
		}

		if( form.get('listselected') === undefined  || form.get('listselected') === 'none' || form.get('listselected') === null ) {
			return {acceptance: false, msg: 'Recuerde seleccionar una "LISTA"'};
		}
		
		return {acceptance: true, msg: ''};
	},
	actions: {
		show_editor: function(option) {
			$('.form-setup-content').hide();
			$('.create-email-spot').show();
			var msg = '';
			switch (option) {
				case 'optin':
					msg = 'Doble Optin';
					var mail = this.get('mailforoptin');
					var maildefault = App.defaultmailoptin;
					break;
				case 'welcome':
					msg = 'Bienvenida';
					var mail = this.get('mailforwelcome');
					var maildefault = App.defaultmailwelcome;
					break;
				case 'notify':
					msg = 'Notificación';
					var mail = this.get('mailfornotify');
					var maildefault = App.defaultmailnotify;
					break;
			}
			if( mail !== undefined ) {
				mail = ( typeof(mail) === 'object' ) ? mail : JSON.parse(mail);
			}
			objMail = ( mail === undefined ) ? maildefault : mail;
			
			$('.title-advanced-editor').html('<h5>Correo de ' + msg + ' </h5>');
			$('.here-comes-frame').html('<iframe id="iframeEditor" src="' + config.baseUrl + 'mail/editor_frame" width="100%" onload="iframeResize()" seamless></iframe>');
			$('#btn-for-' + option).show();
		},
		create_optin_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforoptin', editor);
			this.cleanEditor();
		},
		create_welcome_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforwelcome', editor);
			this.cleanEditor();
		},
		create_notify_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailfornotify', editor);
			this.cleanEditor();
		},
		next: function(form) {
			var result = this.checkValues(form);
			if(result.acceptance) {
				this.handleSavePromise(this.content.save(), 'forms.new', 'Se han aplicado los cambios');
			}
			else {
				$.gritter.add({title: 'Cuidado', text: result.msg, sticky: false, time: 5000});
			}
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsRemoveRoute = Ember.Route.extend({
	model: function(){
		return this.store.find('form');
	}
});

App.FormsRemoveController = Ember.ObjectController.extend( Ember.SaveHandlerMixin, {
	actions: {
		eliminate: function() {
			var form = this.get('model');
			form.deleteRecord();
			this.handleSavePromise(form.save(), 'forms.index', 'Se ha eliminado el formulario exitosamente'),
					
			function (error) {
				form.rollback();
            };
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsCodeRoute = Ember.Route.extend({
	
});

App.FormsCodeController = Ember.ObjectController.extend({
	actions: {
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsHtmlRoute = Ember.Route.extend({
	
});

App.FormsHtmlController = Ember.ObjectController.extend({
	actions: {
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsUpdatingRoute = Ember.Route.extend({
	model: function(){
		return this.store.createRecord('form');
	},
	deactivate: function () {
		this.doRollBack();
	},
	contextDidChange: function() {
		this.doRollBack();
		this._super();
    },
	doRollBack: function () {
		var model = this.get('currentModel');
		if (model && model.get('isDirty') && model.get('isSaving') == false) {
			model.rollback();
		}
	}
});

App.FormsUpdatingController = Ember.ObjectController.extend( Ember.SaveFormHandlerMixin, {
	selectofdbases: [],
	setSelectOfDbases: function() {
		var t = this;
		this.store.find('dbase').then(function(dbase) {
			var dbases = dbase.get('content');
			var values = [];
			for(var i = 0; i < dbases.length; i++) {
				var obj = {id: dbases[i].get('id'), name: dbases[i].get('name')};
				values.push(obj);
			}
			t.set('selectofdbases', values);
		});
	}.observes('content'),
	cleanEditor: function() {
		$('.title-advanced-editor').empty();
		$('.here-comes-frame').empty();
		$('.create-email-spot').hide();
		$('.btn-form-email-creator-save').hide();
		$('.form-setup-content').show();
	},
	checkValues: function(form) {
		if( form.get('name') === undefined ||  form.get('name').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar un NOMBRE al formulario'};
		}
		
		if( ( form.get('urlsuccess') === undefined || form.get('urlsuccess').length === 0 ) || ( form.get('urlerror') === undefined ) || form.get('urlerror').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar las URLs de EXITO y ERROR'};
		}
		
		if( form.get('updatenotify') ) {
			if( form.get('updatenotifysubject') === undefined && form.get('updatenotifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para AVISO DE ACTUALIZACIÓN'};
			}
			var notify_update_mail = ( form.get('mailforupdatenotify') === undefined ) ? JSON.stringify(App.defaultmailcontactnotify) : form.get('mailforupdatenotify');
			
			form.set('updatenotifymail', JSON.stringify({	
									subject: form.get('updatenotifysubject'), 
									fromemail: form.get('updatenotifyfromemail'),
									fromname: form.get('updatenotifyfromname'),
									reply: form.get('updatenotifyreplyto'),
									mail: notify_update_mail }) );
		}
		
		if( form.get('notify') ) {
			if( form.get('notifysubject') === undefined && form.get('notifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para NOTIFICACIÓN'};
			}
			var notify_mail = ( form.get('mailfornotify') === undefined ) ? JSON.stringify(App.defaultmailnotify) : form.get('mailfornotify');
			
			form.set('notifymail', JSON.stringify({
									subject: form.get('notifysubject'), 
									fromemail: form.get('notifyfromemail'),
									fromname: form.get('notifyfromname'),
									reply: form.get('notifyreplyto'),
									mail: notify_mail }) );
		}
		
		if( form.get('dbaseselected') === undefined  || form.get('dbaseselected') === 'none' || form.get('dbaseselected') === null ) {
			return {acceptance: false, msg: 'Recuerde seleccionar una "BASE DE DATOS"'};
		}
		
		return {acceptance: true, msg: ''};
	},
	actions: {
		show_editor: function(option) {
			$('.form-setup-content').hide();
			$('.create-email-spot').show();
			var msg = '';
			switch (option) {
				case 'updatenotify':
					msg = 'Notificación a contacto';
					var mail = this.get('mailforupdatenotify');
					var maildefault = App.defaultmailcontactnotify;
					break;
				case 'notify':
					msg = 'Notificación';
					var mail = this.get('mailfornotify');
					var maildefault = App.defaultmailnotify;
					break;
			}
			if( mail !== undefined ) {
				mail = ( typeof(mail) === 'object' ) ? mail : JSON.parse(mail);
			}
			objMail = ( mail === undefined ) ? maildefault : mail;
			
			$('.title-advanced-editor').html('<h5>Correo de ' + msg + ' </h5>');
			$('.here-comes-frame').html('<iframe id="iframeEditor" src="' + config.baseUrl + 'mail/editor_frame" width="100%" onload="iframeResize()" seamless></iframe>');
			$('#btn-for-' + option).show();
		},
		create_notify_contact_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforupdatenotify', editor);
			this.cleanEditor();
		},
		create_notify_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailfornotify', editor);
			this.cleanEditor();
		},
		next: function(form) {
			this.content.set('type', 'Updating');
			var result = this.checkValues(form);
			if(result.acceptance) {
				this.handleSavePromise(this.content.save(), 'forms.new', 'Se han aplicado los cambios');
			}
			else {
				$.gritter.add({title: 'Cuidado', text: result.msg, sticky: false, time: 5000});
			}
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsEditupdateRoute = Ember.Route.extend({
	deactivate: function () {
		this.doRollBack();
	},
	contextDidChange: function() {
		this.doRollBack();
		this._super();
    },
	doRollBack: function () {
		var model = this.get('currentModel');
		if (model && model.get('isDirty') && model.get('isSaving') == false) {
			model.rollback();
		}
	}
});

App.FormsEditupdateController = Ember.ObjectController.extend( Ember.SaveFormHandlerMixin, {
	selectofdbases: [],
	setSelectOfDbases: function() {
		if(this.content.get('dbaseselected') === undefined) {
			this.content.set('dbaseselected', this.get('dbaseselectedvalue'));
		}
	}.observes('content.dbaseselected'),
			
	somefunc: function() {
		console.log($('#email-notify'))
	}.property('notify'),
	
	loadData: function() {
		var t = this;
		this.set('dbaseselectedvalue', this.content.get('dbaseselected'));
		this.store.find('dbase').then(function(dbase) {
			var dbases = dbase.get('content');
			var values = [];
			for(var i = 0; i < dbases.length; i++) {
				var obj = {id: dbases[i].get('id'), name: dbases[i].get('name')};
				values.push(obj);
				if(dbases[i].get('id') == t.content.get('dbaseselected')) {
					t.set('dbaseselectedfield', obj);
				}
			}
			t.set('selectofdbases', values);
		});
		
		var form = this.content;
		
		var updatenotifyinfo = JSON.parse(form.get('updatenotifymail'));
		if( updatenotifyinfo ) {
			form.set('mailforupdatenotify', updatenotifyinfo.mail);
			form.set('updatenotifysubject', updatenotifyinfo.subject);
			form.set('updatenotifyfromemail', updatenotifyinfo.fromemail);
			form.set('updatenotifyfromname', updatenotifyinfo.fromname);
			form.set('updatenotifyreplyto', updatenotifyinfo.reply);
		}

		var notifyinfo = JSON.parse(form.get('notifymail'));
		if( notifyinfo ) {
			form.set('mailfornotify', notifyinfo.mail);
			form.set('notifysubject', notifyinfo.subject);
			form.set('notifyfromemail', notifyinfo.fromemail);
			form.set('notifyfromname', notifyinfo.fromname);
			form.set('notifyreplyto', notifyinfo.reply);
		}
	}.observes('content'),
	cleanEditor: function() {
		$('.title-advanced-editor').empty();
		$('.here-comes-frame').empty();
		$('.create-email-spot').hide();
		$('.btn-form-email-creator-save').hide();
		$('.form-setup-content').show();
	},
	checkValues: function(form) {
		if( form.get('name') === undefined ||  form.get('name').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar un NOMBRE al formulario'};
		}
		
		if( ( form.get('urlsuccess') === undefined || form.get('urlsuccess').length === 0 ) || ( form.get('urlerror') === undefined ) || form.get('urlerror').length === 0 ) {
			return {acceptance: false, msg: 'Recuerde dar las URLs de EXITO y ERROR'};
		}
		
		if( form.get('updatenotify') ) {
			if( form.get('updatenotifysubject') === undefined && form.get('updatenotifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para AVISO DE ACTUALIZACIÓN'};
			}
			var notify_update_mail = ( form.get('mailforupdatenotify') === undefined ) ? JSON.stringify(App.defaultmailoptin) : form.get('mailforupdatenotify');
			
			form.set('updatenotifymail', JSON.stringify({	
									subject: form.get('updatenotifysubject'), 
									fromemail: form.get('updatenotifyfromemail'),
									fromname: form.get('updatenotifyfromname'),
									reply: form.get('updatenotifyreplyto'),
									mail: notify_update_mail }) );
		}
		
		if( form.get('notify') ) {
			if( form.get('notifysubject') === undefined && form.get('notifyfromemail') === undefined ) {
				return {acceptance: false, msg: 'Recuerde completar los campos de "ASUNTO" y "DE" en la edición de correo para NOTIFICACIÓN'};
			}
			var notify_mail = ( form.get('mailfornotify') === undefined ) ? JSON.stringify(App.defaultmailnotify) : form.get('mailfornotify');
			
			form.set('notifymail', JSON.stringify({
									subject: form.get('notifysubject'), 
									fromemail: form.get('notifyfromemail'),
									fromname: form.get('notifyfromname'),
									reply: form.get('notifyreplyto'),
									mail: notify_mail }) );
		}

		if( form.get('dbaseselected') === undefined  || form.get('dbaseselected') === 'none' || form.get('dbaseselected') === null ) {
			return {acceptance: false, msg: 'Recuerde seleccionar una "BASE DE DATOS"'};
		}
		
		return {acceptance: true, msg: ''};
	},
	actions: {
		show_editor: function(option) {
			$('.form-setup-content').hide();
			$('.create-email-spot').show();
			var msg = '';
			switch (option) {
				case 'updatenotify':
					msg = 'Notificación a contacto';
					var mail = this.get('mailforupdatenotify');
					var maildefault = App.defaultmailcontactnotify;
					break;
				case 'notify':
					msg = 'Notificación';
					var mail = this.get('mailfornotify');
					var maildefault = App.defaultmailnotify;
					break;
			}
			if( mail !== undefined ) {
				mail = ( typeof(mail) === 'object' ) ? mail : JSON.parse(mail);
			}
			objMail = ( mail === undefined ) ? maildefault : mail;
			
			$('.title-advanced-editor').html('<h5>Correo de ' + msg + ' </h5>');
			$('.here-comes-frame').html('<iframe id="iframeEditor" src="' + config.baseUrl + 'mail/editor_frame" width="100%" onload="iframeResize()" seamless></iframe>');
			$('#btn-for-' + option).show();
		},
		create_notify_contact_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailforupdatenotify', editor);
			this.cleanEditor();
		},
		create_notify_mail: function(form) {
			var editor = document.getElementById('iframeEditor').contentWindow.catchEditorData();
			form.set('mailfornotify', editor);
			this.cleanEditor();
		},
		next: function(form) {
			var result = this.checkValues(form);
			if(result.acceptance) {
				this.handleSavePromise(this.content.save(), 'forms.new', 'Se han aplicado los cambios');
			}
			else {
				$.gritter.add({title: 'Cuidado', text: result.msg, sticky: false, time: 5000});
			}
		},
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});

App.FormsLinkRoute = Ember.Route.extend({
	
});

App.FormsLinkController = Ember.ObjectController.extend({
	actions: {
		cancel: function() {
			this.get("model").rollback();
			this.transitionToRoute('forms.index');
		}
	}
});